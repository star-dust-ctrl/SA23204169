---
title: "Homework-2023.10.30"
author: "Huiyang Peng"
date: "2023-10-30"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Homework-2023.10.30}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include=FALSE}
## Global options
knitr::opts_chunk$set(cache = TRUE)
```

# Metropolis-Hastings sampler Algorithm

## Restate

证明Metropolis-Hastings sampler Algorithm在连续情形下的平稳性。

## Proof

连续情形下，目标pdf为$f$, proposal distribution为$g(r|s)$，接受概率为$\alpha(s,t)=\min\{1,\frac{f(t)g(s|t)}{f(s)g(t|s)}\}$。转移核为$K(r,s)=I(s\neq r)\alpha(r,s)g(s|r)+I(s=r)[1-\int\alpha(r,s)g(s|r)ds]$。

Proof:

$K(r,s)f(r)=I(s\neq r)\min\{1,\frac{f(s)g(r|s)}{f(r)g(s|r)}\}g(s|r)f(r)+I(s=r)f(r)-I(s=r)\int \alpha(r,s)g(s|r)f(r)ds\\=I(s\neq r)\min\{f(r)g(s|r),f(s)g(r|s)\}+I(s=r)f(r)-I(s=r)\int\min\{f(r)g(s|r),f(s)g(r|s)\}ds$.

同理有：

$K(s,r)f(s)\\=I(r\neq s)\min\{f(s)g(r|s), f(r)g(s|r)\}+I(r=s)f(s)-I(r=s)\int\min\{f(s)g(r|s), f(r)g(s|r)\}dr$.

比较即可得到$K(r,s)f(r)=K(s,r)f(s)$.

# Exercise 8.1

## Restate

实现两样本的Cramer-von Mises同分布检验，作为一个置换检验。并将其用于Example 8.1和Example 8.2。

```{r}
# ecdf
F.n <- function(para, vec){
    result <- numeric(length(vec))
    for (i in 1:length(vec)) {
      result[i] <- mean(vec[i]>=para)
    }
    return(result)
  }
# completion of Two-Sample Cramer-von Mises test
cmv.test <- function(x,y){
  n = length(x)
  m = length(y)
  res = m * n / (m+n)^2 * (sum((F.n(x,x)-F.n(y,x))^2)+sum((F.n(x,y)-F.n(y,y))^2))
  return(res)
}
```

```{r}
# permutation
attach(chickwts)
x <- sort(as.vector(weight[feed == "soybean"]))
y <- sort(as.vector(weight[feed == "linseed"]))
detach(chickwts)
D0 <- cmv.test(x,y)
R <- 999
z <- c(x, y)
K <- 1:26
D <- numeric(R)
set.seed(0)
for (i in 1:R) {
  k <- sample(K, size = 14, replace = FALSE)
  x1 <- z[k]
  y1 <- z[-k]
  D[i] <- cmv.test(x1, y1)
}
p <- mean(c(D0, D) >= D0)
p
```

# Exercise 8.3

## Restate

等方差的Count 5检验基于极限点的最大个数。Example 6.15展示了这个方法对于不等的样本量不适用。实现一种基于极限点的最大个数的等方差的置换检验，使得其对于样本量不等时仍然可以有效。

```{r}
count5 <- function(x, y) {
  X <- x - mean(x)
  Y <- y - mean(y)
  outx <- sum(X > max(Y)) + sum(X < min(Y))
  outy <- sum(Y > max(X)) + sum(Y < min(X))
  return(as.integer(max(c(outx, outy))))
}

counttest <- function(x,y, repsize = 1000, seed = 0){
  n1 <- length(x)
  n2 <- length(y)
  z <- c(x, y)
  N <- n1 + n2
  K <- 1:N
  D0 <- count5(x, y)
  D <- numeric(repsize - 1)
  set.seed(seed)
  for (i in 1:(repsize - 1)) {
    k <- sample(K,size = n1, replace = FALSE)
    x1 <- z[k]
    y1 <- z[-k]
    D[i] <- count5(x1, y1)
  }
  p <- mean(c(D0, D) >= D0)
  return(p)
}
```

```{r}
# simulate when sigma1 = sigma2
n1 <- 20
n2 <- 30
mu1 <- mu2 <- 0
sigma1 <- 1
sigma2 <- 1
m <- 1000
set.seed(0)
pvalue <- replicate(m, expr={
x <- rnorm(n1, mu1, sigma1)
y <- rnorm(n2, mu2, sigma2)
counttest(x, y)
})
table(pvalue)
```

```{r}
# simulate when sigma1 != sigma2
n1 <- 20
n2 <- 30
mu1 <- mu2 <- 0
sigma1 <- 1
sigma2 <- 2
m <- 1000
set.seed(0)
pvalue <- replicate(m, expr={
x <- rnorm(n1, mu1, sigma1)
y <- rnorm(n2, mu2, sigma2)
counttest(x, y)
})
table(pvalue)
```